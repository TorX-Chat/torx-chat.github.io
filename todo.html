<!DOCTYPE html>
<html>
<head>
	<title>TorX | Project-Wide Unified TODO List</title>
	<link rel='shortcut icon' href='https://raw.githubusercontent.com/TorX-Chat/torx-gtk4/main/other/icon_round.ico'/>
	<style>
		a:link, a:visited {
			color: #add8e6;
		}
		body {
			margin: 0;
			padding: 0;
			height: 200%; /* to make sure there's enough content to scroll */
			background-color: #181a1b;
			color: white;
		}
		nav {
			position: fixed;
			width: 100%;
			background-color: #333;
			color: white;
			padding: 5px 0;
			text-align: center;
			z-index: 1000; /* ensures the nav stays on top of other content */
		}
		section {
			margin-left: 5px;
			padding-top: 30px; /* extra space to ensure content is not hidden behind the fixed nav */
		}
	</style>
</head>
<body>

	<nav>
		<a href="index.html">Home</a>
		<a href="#schedule">Schedule</a>
		<a href="#library">Library</a>
		<a href="#ui">UI</a>
		<a href="#gtk4">GTK4</a>
		<a href="#flutter">Flutter</a>
	</nav>
	<section id="schedule">
		<h1>Project-Wide Unified TODO List / Schedule</h1>
		<img alt="Logo" width="256" height="256" src="https://raw.githubusercontent.com/TorX-Chat/torx-gtk4/main/other/scalable/apps/logo-torx-symbolic.svg" align="right" style="position: relative; top: 0; left: 0;">
		<h3>Schedule</h3>
		<h4>Ideal full-release date:</h4>
		<ul>
			<li>Before November 5th 2024 (Election day)</li>
		</ul>
		<h4>Minimal project-wide goals before full-release:</h4>
		<ul>
			<li>Proper documentation of base protocols / handshake</li>
			<li>Doxygen compatible documentation (?) at least for UI exposed library functions</li>
			<li>Windows build</li>
			<li>MacOS build</li>
			<li>Library stability</li>
		</ul>	
		<h4>Ideal project-wide goals before full-release:</h4>
		<ul>
			<li>Voice notes (in the UI clients)</li>
			<li>Walkie-Talkie mode (in the UI clients)</li>
			<li>Ncurses client</li>
			<li>CLI/API client for integration with AI bots/etc (Julia)</li>
			<li>Google PlayStore listing</li>
			<li>Packaging for most major Linux/BSD distributions (official or otherwise)</li>
			<li>iOS support</li>
		</ul>
		<h4>For public discussion:</h4>
		<ul>
			<li>Git submodules vs ExternalProjects_Add vs other?</li>
			<li>Seperate "keys" and "settings" databases? Currently a bad setting can crash the application (such as a bunk sticker). UI developers should work to prevent this, rather than working around the problem in a brutal fashion such as by encouraging users to delete their settings database. (which would be very hard on mobile). If implementing, remember to implement in change_password.</li>
			<li>Use timezone info to determine default torrc? (this could really be a UI thing, though we do have the censored_region variable in lib). Timezone + language would be more effective.</li>
		</ul>
	<section id="library">
		<h3>TODO List for TorX Library:</h3>
		<h4>High Priority / Security Audit:</h4>
		<ul>
			<li>2024/04/26: Group PM messages are STILL going to the wrong person sometimes. Cause is unknown. Displays as "fail" with right recipient name, but the wrong person receives it.</li>
			<ul>
				<li>Spagetti Code: Audit message_prep && message_distribute</li>
			</ul>
			<li>libevent.c: Review accept_conn, error_conn, close_conn, loop exit</li>
			<li>libevent.c read_conn: be careful not to cause reads beyond message length (event_strc->buffer_len)</li>
			<li>Threadsafety: Certain pointers such as peer[n].message[i].message could be subject to race conditions in limited circumstances (ie, if it were to be modified at the same time it is being saved), which is unlikely. The circumstances that could cause this occur where it is passed to a function without wrapping the function in torx_read/torx_unlock. Currently we just pass tmp_message, which is a copy of the message location. This issue also exists in GTK4. Solution: implement getter_string / _from_i</li>
			<li>Need a red team building malicious or buggy client/library, which will send undersized/oversized messages, spam attacks, etc</li>
			<li>Invites need to be one-time-use (they are not) and non-transferrable (i presume they are non-transferrable, but check). ENUM_GROUP_OFFER_ACCEPT_REPLY always signs / issues an invitation... is this a problem? if ENUM_GROUP_OFFER_ACCEPT_REPLY is utilized during every handshake then its a problem because not just the inviter will sign but everyone... meaning that people can spoof who actually invited them.</li>
			<li>To reveal 1300+ thread-unsafe reads, remove -Wno-unsafe-buffer-usage from CMakeLists.txt</li>
			<li>Search (again) for ]; and ] = { then ensure zero'd.</li>
			<li>!v3auth is no longer considered safe. Appears to be operating full duplex. If !v3auth, must utilize auth pipes. Then we can tear out some legacy code and perhaps ENUM_PROPOSE_UPGRADE, which is not well tested. Need to test with an old Tor binary.</li>
			<li>Verify that kill_delete == 0 --> 'Block' and MUST change the priv/onion/peeronion to some fakes, but retain message data and name. Could set it to generate legitimate fakes, or invalid ones. Unsure about which is best.</li>
			<li>Callback for invalid or incomplete message (which could be illict attempts to ping). Minor notice for incomplete, major for invalid + counter. Warning: After a file is cancelled, a peer can keep sending data or re-start sending data and we receive/disgard it. This could be exploited to monitor a peer. Need to somehow notify a peer that such packets are still inbound.</li>
			<li>Need a red team building malicious or buggy client/library, which will send undersized/oversized messages, spam attacks, etc.</li>
		</ul>
		<h4>Medium Priority:</h4>
		<ul>
			<li>CMakeLists.txt: set(SSL_ARCH linux-x86_64) is hardcoded, except on android. will be issues on *pi, postmarketOS, macbooks, etc.</li>
			<li>CMakeLists.txt files can be ran through AI. Add debug messages with message(STATUS hello) and run with cmake --trace for debugging.</li>
			<li>Eliminate fork() by implementing CreatePipe or other, so we can build on Windows</li>
			<li>Bug: Repeated blocking/unblocking of a peer causes crashes.</li>
			<li>Bug: Private messages are not full duplex? (seems not sending on orange/recvfd)</li>
			<li>save_dir_always_ask should be eliminated in GTK4, in favor of download_dir. GTK4/Flutter should have a set/unset + directory picker</li>
			<li>Streaming a group message is going to be a message struct bloat issue because, unlike other stream messages, upon outbound send it is not deleted from group_ctrl (the group_ctrl n,i is not zero_i'd). The solution is to somehow track when all the attempts are done (perhaps in message_send) and then zero_i it (see: sfaoij2309fjfw)</li>
			<li>Consider moving the message size and protocol behind the .message pointer (so we can avoid copying moving message when signing)</li>
			<li>Implement _from_i functions in Gtk/Lib</li>
			<li>Multi-Device / Blinded keys. Use the nonce method to generate blinded keys. Do it using onion_gen.c Upload it using HSPOST. See src/feature/hs/hs_common.c for creation of blinded keys. See any mentions of "blind" "period" "time" in the src. I think HSPOST is somehow combined with ADD_ONION to publish? Unsure and will need to ask #tor-dev</li>
			<li>GROUP FILE TRANSFER Documentation: Outbound uses peer_n fd for disk reads, Inbound uses group_ctrl fd for disk writes. When receiving file request, it appears we store outbound date in the group_peer_n. This needs to be documented/understood. When changing file status in process_pause_cancel, we might need to iterate through the relevant group_peer_n and set their status too? idk if we store status there or only transfer amount.</li>
			<li>Tor not dying keeps onions online after crash. Consider the viability of a Tor Killer process that will kill Tor if TorX's PID dies. It could just be a wait() kill() process, being forked from TorX with possession of both Tor and TorX PIDs. This would be useful to ensure that Tor and its hidden services aren't left hanging if TorX crashes or is improperly closed. NOTE: probably better to use just not use detached? Next startup would kill tor via PID.</li>
			<li>We can't support uint64_t file sizes because ftell/fseek only support long int. Unsure what to do about this. It affects our file transfer protocols.</li>
			<li>accept_automatically. Can either be a toggle or a size slider. size_t is probably most logical. Could also have a list of accepted filetypes. NOTE: Enabling this option will require a check for download_dir. Also, this option should could be DANGEROUS for insecure platforms like Windows/OSX/iOS/Android, where CSAM scanning exists.</li>
			<li>If a split_folder exists, files inside should be labelled via truncated checksum rather than filename.</li>
			<li>Hash is written to disk in plaintext for our .split file. Perhaps we should encrypt (no) or salt + rehash it (not all hashes, just this hash written to .split file). The reason we don't is because the file itself is written next to it, so what is the security in having the hash salted? We do attempt to securely delete .split files.</li>
			<li>Requesting a 1 byte file in full duplex causes an integer overflow / request of a 18446744073709551615 byte file, causing offerer to crash *** Need a sanity check that requests are not > file size</li>
			<li>Sodium memory management overhead: Check for compile-time flags that could disable the wasted pages except on debug builds. sodium_malloc() wastes too much memory by allocating 4kb of space for each malloc. See <a href="https://github.com/jedisct1/libsodium/blob/master/src/libsodium/sodium/utils.c">HAVE_PAGE_PROTECTION</a></li>
			<li>iOS (Orbot) / System Tor: We need to re-write tor_call so that all calls are on a single connection and ADD_ONION does not utilize "Detached". See Tor's control-spec.txt. That will enable us to run safely without control_password. However it will not achieve Orbot compatibility at least on Android (which starts up with a random CTRL_PORT). We could work with their devs to get them to resolve the issue.</li>
			<li>Clean up error messages / notices / checkpoints using macro defined levels to determine whether debug level + whether they contain sensitive info.</li>
		</ul>
		<h4>Low Priority:</h4>
		<ul>
			<li>Convert or eliminate remaining ~100 printf to error_printf</li>
			<li>Takedown_onion must call disconnect_forever in a threadsafe manner. We've tried everything (evbuffer_lock, event_base_once, etc) and can't find a way.</li>
			<li>file_init() calculates a checksum every time it offers a file. We have modification time now but we don't use it for anything.</li>
			<li>Seems like old file descriptors get closed. If nothing is written in a long time, fd might get closed. Do we have any long-term fd?</li>
			<li>File descriptor leaks and limitations: ulimit -n shows we can only have 1024 file descriptors open at once. That's going to limit the potential of group chats. If we get near the limit, we could shed outbound (sendfd) connections? Not a great solution.</li>
			<li>Multiple offers of the same file to the same peer is undefined behavior, especially when changing filename. Test it.</li>
			<li>Lots of warnings occur when restarting Tor.</li>
			<li>Cascade deletion of messages and peer specific settings may be untested</li>
			<li>atoi() should be replaced by strtoll(arg, NULL, 10); It sends invalid input to null and returns 0 if bad input.</li>
			<li>We don't have library protection against running twice. We implement "running" check in GTK. For now, this is ideal. No reason to change this.</li>
			<li>Is --keygen/--key-expiration only for relays? OfflineMasterKey/SigningKeyLifetime</li>
			<li>man atexit. May be useful. Note: Doesn't trigger on signals (ie ctrl + c). Not sure why this would be useful since we handle all exit() calls.</li>
			<li>Add a counter or bunch of counters that increment every time a malloc occurs, so we can know how many leaks we got. (optionally in what areas)</li>
			<li>Public Groups could hypothetically also be shortened in length (pointless), or allow external generation (pointless)</li>
			<li>Consider having UTF8 validator shift forward over any non-utf8 bytes, for use in libevent.c and perhaps message_send (to avoid sql issues), rather than discarding whole messages.</li>
			<li>Consider replacing fork() exec() with posix_spawn()</li>
			<li>Implement run_binary with optional STDIN string, for verify_config (requires stdin), which, hash_password, get_tor_version, etc.</li>
			<li>For GROUP_PEER, .message and .message_len could be double pointer + pointer, respectively. Unsure if viable and how we would re-structure our message struct for that. This can be ignored for now so long as we aren't having bugs.</li>
		</ul>
		<h4>Possibly no longer relevant:</h4>
		<ul>
			<li>Tor going idle. "idle" ... "While not bootstrapping". Note: Not "dormant". See #tor logs for clarification.</li>
			<li>broadcast_threaded should ONLY message_send WHEN WE ARE CONNECTED, otherwise it will queue up all our messages and then send them all at once when we get online... totally defeating the purpose of a queue. This is easy to implement for ENUM_OWNER_CTRL (we can just check online status), but harder to implement with GROUP_CTRL.</li>
			<li>When requesting group files (in message_prep currently and select_peer, both), we should request a *random* largest section (+/- 1), rather than the first available one, to help the spread of the file into the network.</li>
			<li>If a peer pauses or cancels, or otherwise ignores file requests, some sections may end up unrequested until restart.</li>
			<li>Test in debugger before investing time: illegal reads could result if we have >10 group files, since everyting occurs on peer[n].file[f] of group_peer_n, which may not be allocated.</li>
			<li>If there is any file transfer corruption caused by repeated pauses and restarts, it is due to races on ].fd_out_</li>
			<li>2024/03/11 Utilizing the return of message_insert(), we could permit the modification of messages ... but only group messages, ???</li>
		</ul>
	<section id="ui">
		<h3>TODO List for Both UIs (Flutter and GTK4):</h3>
		<ul>
			<li>Have a tooltip that shows TorX-IDs, at least on the group's peerlist</li>
			<li>Need to implement our fancy new .SVG icons (can wait for GTK4.14)</li>
			<li>Flash entry box red when no nick is entered for generating (generate_onion) or adding onion (save_peer), or when an invalid onion is passed (bad checksum)</li>
			<li>Multi-Select: Tables should allow multiple selections for deletion. It should show only Delete (or Accept + Reject).</li>
			<li>If someone is fast on the censored region toggle while waiting for login, it will save the setting but not take effect until next restart</li>
			<li>We need to do sanity checks on sticker/image data or people can be crashed with junk stickers/images. (Send 0 size .gif or bunk data for testing)</li>
			<li>Add/Generate pages need max length for entry fields (56 bytes), since we still use arbitrary maximum lengths for peernicks</li>
			<li>Facilitate msg searching via gtk_list_view_scroll_to in GTK4 and ?? in Flutter.</li>
			<li>Should probably have a "doing checksum" spinner or something for file transfers, so people don't add more than once</li>
			<li>Have a toggle for kill_delete. Delete or Disable options.</li>
			<li>Tooltips: Use text_tooltip_ prefix. For flutter, https://material.io/components/tooltips</li>
			<li>String functions in UI should use secure allocators/de-allocators, if possible. (Note: not possible?)</li>
			<li>Consider registering a URI? ie: "torx:" Base64 would be a grup, base32 would be a SING/MULT. is_valid_b32_input( and b64_isvalidchar( in conjunction can determine whether a string is peer/group/trash, for use with 'Search' or invalid input when adding peer.</li>
		</ul>
	<section id="gtk4">
		<h3>TODO List for GTK4 client:</h3>
		<ul>
			<li>Track threads (2) related to appindicator.c/main_gtk4.c and cleanup like we do in library</li>
			<li>Update org.torx.gtk4.desktop file + "make install"</li>
			<li>Create .deb file + Debian repo</li>
			<li>Close to tray should not exist concurrently with minimize to tray</li>
			<li>Review how/where we are finding the torx-tray binary.</li>
			<li>Resolve the GTK3 Critical error that occurs 50% of the time when starting torx-tray.</li>
			<li>Clicking back while modifying peernick causes loss of changes (only in GTK4)</li>
			<li>Scroll direction is inverted, which is annoying but is preferable to not using INVERSION_TEST</li>
			<li>Images should be clickable (to show larger), should automatically render after reaching 100% transferred (inbound).</li>
			<li>Implement _from_i functions in Gtk/Lib</li>
			<li>Threadsafety: we have a lot of places where we retrieve pointer locations with locks and then read them without locks. In the vast majority of cases, this will never be a problem, but we should implement getter_string and _from_i for these cases to eliminate the data race warnings, despite the performance implications. (ctrl+f &mutex_ and torx_unlock, replace with getter_string / _from_i functions)</li>
			<li>GStreamer or PortAudio library ( https://github.com/PortAudio/portaudio ) to record .wav type audio for voice messages / streaming chat / walkie mode. Notes elsewhere suggest Vorbis being preferable for streamed audio.</li>
			<li>Review any _swapped( and instead set proper args for given ::signal) (note: if signal can't be found in GTK docs, check gobject docs)</li>
			<li>Have some clang specific compile flags. Could add more. See CMakeLists.txt.</li>
			<li>Memory leakage: Free memory. Eliminate memory leaks so that it can valgrind 0. g_object_free()? Unsure how to handle sensitive things.</li>
			<li>Vertical mode: consider putting Send button below the emoji and attach buttons, or simply hide buttons other than Send while typing (like Flutter client).</li>
			<li>CTRL+Enter should create a newline instead of sending. Alternatively add a dropdown list of options for key macros for "Send". See function keypress()</li>
			<li>Gnotification can't use gresource icon. We already worked around it by dropping a .png, but we also have a .png for our .desktop file. If we set icon_logo to NULL, the icon registered with DBUS by .desktop will be used.</li>
			<li>Colored .svg icons will be available from GTK 4.14. Then search our code for gtk_symbolic_paintable_snapshot_symbolic, where we have an example implementation ready.</li>
		</ul>
	<section id="flutter">
		<h3>TODO List for Flutter client:</h3>
		<ul>
			<li>CMakeLists.txt: Depreciate the BUILD_BINARIES argument in favor of checking if they are already built.</li>
			<ul>
				<li>Set BUILD_BINARIES 1</li>
				<li>Resolve issues / causes of unnecessary rebuilds</li>
				<li>Allow forcing of rebuilds for when deps change? CMake can ideally handle this</li>
			</ul>
			<li>CMakeLists.txt: Ship a release version of Tor instead of building from main</li>
			<li>Can we onload and offload message history? Keep last 50 messages of every peer, but dump the rest to save RAM?</li>
			<li>Calling peer_accept() while actively modifying peernick results in modifications being lost</li>
			<li>autoRunOnBoot: true (foreground task) + fix BootBroadcastReceiver.kt, then have a toggle in settings page for both.</li>
			<li>Consider requesting battery optimization exemption</li>
			<li>AnimatedBuilder should replace many of our setState calls, for efficiency. Especially: activity button, and send/sticker/attach builds</li>
			<li>Should use gallery with photo_view to allow swipping back/forward to see other images in PhotoView.</li>
			<li>Can't change app name on the fly, but can change icon. Could use it to notify user of messages or put alternate icon option (calculator, or something people never use). "The calculator theoretically opens chat but it doesn't work anymore. They said it requires entering a specific calculation," Micay said.</li>
			<li>Prevent un-encrypted backups of android data? Most chat apps do this but I'm on the fence because our data is encrypted, and we do want to support history migration. GrapheneOS project has some info that suggests we can block only unencrypted backups.</li>
			<li>Consider having a popup when adding something to clipboard. The clipboard would have a "Clear clipboard" and "Exit" option, along with a warning about other applications being able to steal clipboard contents. In some softwares (ie password managers), after ~45 seconds, it will clear the clipboard.</li>
			<li>MaterialBanner() anywhere it exists needs to be checked for functionality. It works at least on RouteTorrc but elsewhere may be non-functional.</li>
			<li>Delete getTemporaryDirectory().path/qr.png on program startup and shutdown. Zero and delete might be best.</li>
			<li>"Whenever items list is updated, ListView shall be updated automatically." https://googleflutter.com/flutter-add-item-to-listview-dynamically/ https://stackoverflow.com/questions/51343567/append-items-dynamically-to-listview</li>
			<li>Experiment in Noti with grouping notifications per-user.</li>
			<li>Comment out any unused color and language strings. Ensure that we don't have any strings not in our languages file.</li>
			<li>Message box height: 400 is too tall. Figure out a way to avoid hard coding it.</li>
			<li>We lose TorX log and Tor log contents every time we .detach, so we might consider to store it in a library defined C pointer so it stays in RAM. We would just need to create the pointer in lib and the remaining work is done in flutter. However, this is kind of contrary to the direction we are going, which is to be able to minimize RAM usage in Android.</li>
		</ul>
</body>
</html>
